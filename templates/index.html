<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rate Alarm Extractor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            /* Professional Dark Background */
            background: linear-gradient(135deg, #101520 0%, #080a10 100%);
            min-height: 100vh;
            padding: 30px;
            overflow-x: hidden;
            color: #e0e0e0;
        }
        
        /* Subtle Grid and Glow for dynamic feel */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 190, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 190, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.3;
        }
        
        .container {
            max-width: 950px;
            margin: 0 auto;
            background: rgba(18, 24, 35, 0.95); /* Deeper, less transparent */
            border-radius: 12px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.5),
                inset 0 0 10px rgba(0, 190, 255, 0.1);
            overflow: hidden;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(30, 40, 60, 1);
        }
        
        .header {
            /* Muted, professional gradient */
            background: linear-gradient(135deg, 
                rgba(20, 30, 50, 1) 0%, 
                rgba(30, 40, 70, 1) 100%);
            color: #ffffff;
            padding: 30px 40px;
            /* Centered titles */
            text-align: center; 
            border-bottom: 2px solid #00bfff;
        }
        
        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: 2.2em;
            font-weight: 900;
            margin-bottom: 5px;
            /* Use a professional primary color */
            color: #00bfff; 
            text-shadow: 0 0 5px rgba(0, 190, 255, 0.5);
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.7;
            font-weight: 300;
            color: #cccccc;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-section {
            background: #202838;
            border: 3px solid #00bfff;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .upload-section:hover {
            border-color: #00e5ff;
            background: #283042;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 190, 255, 0.2);
        }
        
        .upload-icon {
            font-size: 3em;
            color: #00bfff;
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #ffffff;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: #00bfff;
            color: #101520;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .upload-btn:hover {
            background: #00e5ff;
            box-shadow: 0 4px 15px rgba(0, 190, 255, 0.4);
            transform: scale(1.02);
        }
        
        .warning-note {
            background: rgba(255, 150, 0, 0.1);
            border-left: 5px solid #ff9600;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            color: #ff9600;
            font-size: 0.95em;
        }

        .download-warning-note {
            background: rgba(255, 0, 50, 0.1);
            border-left: 5px solid #ff4444;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            color: #ff4444;
            font-size: 0.95em;
            font-weight: 500;
            display: none; /* Controlled by JS */
        }
        
        .file-info {
            background: #202838;
            border: 1px solid #405070;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
            color: #a0a0a0;
            font-weight: 500;
            line-height: 1.6;
        }
        
        .file-info strong {
            color: #00bfff;
            font-weight: 600;
        }

        .progress-section {
            margin: 30px 0;
            display: none;
        }
        
        .progress-container {
            background: #202838;
            border-radius: 10px;
            padding: 25px;
            text-align: left;
            border: 1px solid #405070;
        }
        
        .progress-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.1em;
            color: #00bfff;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #303a4c;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00bfff, #00e5ff);
            border-radius: 4px;
            width: 0%;
            transition: width 0.4s ease;
        }
        
        .progress-status {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: 400;
        }

        /* New Log Styling */
        .processing-log {
            height: 150px;
            background: #181d28;
            border: 1px solid #303a4c;
            border-radius: 8px;
            margin-top: 20px;
            padding: 15px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            color: #00ffaa; /* Green/cyan text for logs */
            white-space: pre-wrap;
            line-height: 1.4;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .log-entry.error {
            color: #ff4444;
        }

        .log-entry.info {
            color: #00bfff;
        }

        .log-entry.success {
            color: #00ffaa;
        }
        
        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-weight: 600;
            text-align: center;
        }
        
        .status-success {
            background: rgba(0, 255, 170, 0.1);
            border: 1px solid #00ffaa;
            color: #00ffaa;
        }
        
        .status-error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
        }
        
        .download-section {
            background: #202838;
            border: 1px solid #405070;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            display: none;
        }
        
        .success-gif {
            margin: 20px 0;
            display: block;
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 190, 255, 0.2);
            margin-left: auto;
            margin-right: auto;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #00ffaa 0%, #00bfff 100%);
            color: #101520;
            text-decoration: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            display: inline-block;
            margin: 15px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 170, 0.4);
            background: linear-gradient(135deg, #00ffcc 0%, #00e5ff 100%);
        }
        
        /* Removed .stats-grid and .stat-card CSS as they are no longer used */

        .format-info {
            background: #151a24;
            border: 1px solid #303a4c;
            padding: 12px;
            margin-top: 30px;
            border-radius: 8px;
            text-align: center;
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        .reset-btn {
            background: #405070;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .reset-btn:hover {
            background: #506080;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 0;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            /* Removed .stats-grid media query adjustment */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rate Alarm Extractor</h1>
            <!-- Change 1: Updated subheading text and centered titles (via .header CSS) -->
            <p>Created by Dumith.D - © All rights reserved 2025</p>
			<p>dumith@live.com</p>
        </div>
        
        <div class="content">
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">⬆️</div>
                <div class="upload-text">
                    <strong>Drag & Drop Excel File</strong><br>
                    or click to select file
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Select Data File
                </button>
            </div>
            
            <div class="warning-note">
                <!-- Change 2: Updated warning note text -->
                <strong>Data Schema Requirement:</strong> Columns "name", "Alarm Source", "Location Info", "Arrived On (ST)", and "Other Information" must be available on the current alarm window. If not available please add the columns before exporting the excel file
            </div>
            
            <div class="file-info" id="fileInfo">
                <strong>📄 Selected File:</strong> <span id="fileName"></span><br>
                <strong>📏 Size:</strong> <span id="fileSize"></span>
            </div>
            
            <div class="progress-section" id="progressSection">
                <div class="progress-container">
                    <div class="progress-title">Processing Status</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-status" id="progressStatus">Initializing...</div>
                </div>

                <!-- Dynamically updating log added here -->
                <div class="processing-log" id="processingLog">
                    Waiting for file upload...
                </div>
            </div>
            
            <div class="status-message" id="statusMessage"></div>
            
            <div class="download-section" id="downloadSection">
                <h3>✅ Data Extraction Complete!</h3>
                
                <!-- Success GIF -->
                <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExaWh2NjhqN3Uxd3hlaGp2cTFtM3VobzN1NDlkdjl3d2praGhhdmJndiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l35uQh8PkJjYKH7tNn/giphy.gif" 
                     alt="Success Animation" 
                     class="success-gif" 
                     id="successGif">
                
                <!-- Change 3: Removed the stats-grid div entirely. Content now flows directly. -->

                <!-- Change 4: Updated warning text (Action Required -> Caution) -->
                <div class="download-warning-note" id="duplicateWarning">
                    ⚠️ Caution: Double-check the output file for duplicates before distribution.
                </div>
                
                <div>
                    <a href="#" class="download-btn" id="downloadBtn">
                        ⬇️ Download Extracted Excel
                    </a>
                    <button class="reset-btn" onclick="resetApp()">
                        🔄 Process New File
                    </button>
                </div>
            </div>
            
            <div class="format-info">
                <strong>Supported formats:</strong> .xlsx, .xls | <strong>Max size:</strong> 16MB
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        const statusMessage = document.getElementById('statusMessage');
        const downloadSection = document.getElementById('downloadSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const processingLog = document.getElementById('processingLog');
        const duplicateWarning = document.getElementById('duplicateWarning');

        /**
         * Dynamically adds a new line to the processing log.
         * @param {string} message - The log text.
         * @param {('info'|'error'|'success')} type - The type of log entry for styling.
         */
        function updateLog(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timeString}] ${message}`;

            processingLog.appendChild(logEntry);
            // Scroll to the bottom to show the latest entry
            processingLog.scrollTop = processingLog.scrollHeight;
        }

        // --- Drag and Drop / Input Handling ---
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            // Reset log display
            processingLog.innerHTML = '';
            updateLog(`File selected: ${file.name}`, 'info');

            // Validate file type
            if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                showStatus('Please select a valid Excel file (.xlsx or .xls)', 'error');
                updateLog('ERROR: Invalid file format detected.', 'error');
                return;
            }

            // Validate file size (16MB limit)
            if (file.size > 16 * 1024 * 1024) {
                showStatus('File size exceeds 16MB limit. Please select a smaller file.', 'error');
                updateLog('ERROR: File size limit exceeded (16MB).', 'error');
                return;
            }

            // Show file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';

            // Start upload and processing
            uploadFile(file);
        }

        // --- Upload and Processing ---
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // Show progress and hide upload
            progressSection.style.display = 'block';
            uploadSection.style.display = 'none';
            setProcessingState(true);

            // Auto-scroll to show the progress section and log
            setTimeout(() => {
                progressSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
            
            // Enhanced progress simulation with log updates
            const progressSteps = [
                { progress: 10, message: 'Uploading file to server...', log: 'Connection established. Uploading file...' },
                { progress: 25, message: 'Reading Excel structure...', log: 'File integrity check complete. Parsing workbook sheets...' },
                { progress: 45, message: 'Filtering alarm data...', log: 'Schema validated. Applying alarm filter rules...' },
                { progress: 65, message: 'Extracting node information...', log: 'Geospatial data extraction for Node B initiated.' },
                { progress: 80, message: 'Processing duplicates...', log: 'Identifying and consolidating duplicate entries...' },
                { progress: 95, message: 'Finalizing output table...', log: 'Data serialization to final output format.' },
                { progress: 100, message: 'Complete!', log: 'Process finished successfully.', final: true }
            ];

            let stepIndex = 0;
            const progressInterval = setInterval(() => {
                if (stepIndex < progressSteps.length) {
                    const step = progressSteps[stepIndex];
                    progressFill.style.width = step.progress + '%';
                    progressStatus.textContent = step.message;
                    updateLog(step.log, step.final ? 'success' : 'info');
                    stepIndex++;
                }
            }, 800);

            // Send actual request to Flask server
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                
                if (data.success) {
                    updateLog('Server processing completed successfully!', 'success');
                    showDownloadSection(data);
                } else {
                    updateLog(`ERROR: ${data.error}`, 'error');
                    showStatus(data.error, 'error');
                    resetUploadSection();
                }
                setProcessingState(false);
            })
            .catch(error => {
                clearInterval(progressInterval);
                updateLog(`NETWORK ERROR: ${error.message}`, 'error');
                showStatus('Network error: ' + error.message, 'error');
                resetUploadSection();
                setProcessingState(false);
            });
        }

        function resetUploadSection() {
            progressSection.style.display = 'none';
            uploadSection.style.display = 'block';
            fileInfo.style.display = 'none';
        }

        // --- Download and Stats Section ---
        function showDownloadSection(data) {
            // Keep progress section visible to show final logs
            // Don't hide it immediately - let user see completion
            downloadSection.style.display = 'block';
            duplicateWarning.style.display = 'block';
            downloadBtn.href = data.download_url;
            setProcessingState(false);

            // Show success message
            showStatus(data.message, 'success');

            // Scroll to download section after a brief delay
            setTimeout(() => {
                downloadSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 2000);

            // Hide progress section after user has time to see final logs
            setTimeout(() => {
                progressSection.style.display = 'none';
            }, 5000);
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        // --- Utility Functions ---
        function resetApp() {
            // Reset all sections
            uploadSection.style.display = 'block';
            fileInfo.style.display = 'none';
            progressSection.style.display = 'none';
            statusMessage.style.display = 'none';
            downloadSection.style.display = 'none';
            duplicateWarning.style.display = 'none';
            processingLog.textContent = 'Waiting for file upload...';
            
            // Clear file input
            fileInput.value = '';
            setProcessingState(false);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        let processingInProgress = false;
        function setProcessingState(processing) {
            processingInProgress = processing;
        }
        
        // Initial setup for reset
        document.addEventListener('DOMContentLoaded', function() {
             resetApp();
        });
    </script>
</body>
</html>





